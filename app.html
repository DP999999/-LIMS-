<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIMS 移动端</title>
    <style>
        :root {
            --primary-color: #2E7D32; /* 农业绿 */
            --accent-color: #4CAF50;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 模态框 (公告) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn-group {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
        }

        /* 通用按钮 */
        button {
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-block { width: 100%; margin-bottom: 10px; }

        /* 页面布局 */
        .page {
            display: none;
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }
        .active { display: block; }
        
        .header {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 主页模块网格 */
        .grid-menu {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
        }
        .menu-card {
            background: var(--card-bg);
            padding: 30px 10px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            border: 1px solid #e0e0e0;
        }
        .menu-card:active { background: #f0f0f0; }

        /* 表单样式 */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .result-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            white-space: pre-wrap;
            border: 1px solid var(--accent-color);
        }

        /* 表格样式 (Module 1) */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 12px; }
        th { background: #f5f5f5; }

        /* 数据记录列表 (Module 3) */
        .data-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
        }
        .data-item small { color: #666; }

    </style>
</head>
<body>

    <div id="disclaimer" class="modal">
        <div class="modal-content">
            <h3>公告</h3>
            <p>本版本为测试版本，如有问题请联系WDP。</p>
            <p>是否同意使用？</p>
            <div class="btn-group">
                <button class="btn-secondary" onclick="closeApp()">拒绝</button>
                <button class="btn-primary" onclick="enterApp()">同意</button>
            </div>
        </div>
    </div>

    <div id="page-home" class="page">
        <div class="header">LIMS 移动端</div>
        <div class="grid-menu">
            <div class="menu-card" onclick="navTo('page-mod1')">1. 小区排列</div>
            <div class="menu-card" onclick="navTo('page-mod2')">2. 计算用药量</div>
            <div class="menu-card" onclick="navTo('page-mod3')">3. 数据记录</div>
            <div class="menu-card" onclick="navTo('page-mod4')">4. 辅助工具</div>
        </div>
    </div>

    <div id="page-mod1" class="page">
        <div class="header"><span onclick="navTo('page-home')">← 返回</span> 小区排列</div>
        <div class="form-group">
            <label>处理数 (整数)</label>
            <input type="number" id="m1-treatments" placeholder="例如: 5">
        </div>
        <div class="form-group">
            <label>重复数 (整数)</label>
            <input type="number" id="m1-reps" placeholder="例如: 3">
        </div>
        <div class="form-group">
            <label>排列类型</label>
            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                <button class="btn-secondary" onclick="generatePlot('RCBD')">随机区组</button>
                <button class="btn-secondary" onclick="generatePlot('RCBD_COL')">区组(错列)</button>
                <button class="btn-secondary" onclick="generatePlot('CRD')">完全随机</button>
            </div>
        </div>
        <div id="m1-output"></div>
    </div>

    <div id="page-mod2" class="page">
        <div class="header"><span onclick="navTo('page-home')">← 返回</span> 计算用药量</div>
        
        <div style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
            <h4>🧪 密度计算</h4>
            <div style="display:flex; gap:10px; align-items:flex-end;">
                <div style="flex:1;">
                    <label>吸取 1ml 重量(g)</label>
                    <input type="number" step="0.001" id="m2-density-weight">
                </div>
                <button class="btn-primary" onclick="calcDensity()">计算</button>
            </div>
            <div id="m2-density-result" style="margin-top:5px; color:var(--primary-color); font-weight:bold;"></div>
        </div>

        <div class="form-group">
            <label>小区单位类型</label>
            <select id="m2-unit-type" onchange="toggleUnitType()">
                <option value="area">面积 (平方米)</option>
                <option value="plant">株数 (株)</option>
            </select>
        </div>

        <div class="form-group">
            <label id="lbl-water">用水量 (升/公顷)</label>
            <input type="number" id="m2-water" value="600">
        </div>

        <div class="form-group">
            <label id="lbl-area">小区面积 (m²)</label>
            <input type="number" id="m2-area-size">
        </div>

        <div class="form-group">
            <label id="lbl-dosage">亩用药量 (g或ml / 亩)</label>
            <input type="number" id="m2-dosage">
        </div>

        <div class="form-group">
            <label>安全系数</label>
            <input type="number" id="m2-safety" value="1.1" step="0.1">
        </div>
        
        <div class="form-group">
            <label>重复次数</label>
            <input type="number" id="m2-reps" value="1">
        </div>

        <button class="btn-primary btn-block" onclick="calcDosage()">确定计算</button>
        
        <div id="m2-result" class="result-box" style="display:none;"></div>
        <button id="btn-save-record" class="btn-secondary btn-block" style="display:none; margin-top:10px;" onclick="saveCurrentCalc()">保存到记录</button>
    </div>

    <div id="page-mod3" class="page">
        <div class="header"><span onclick="navTo('page-home')">← 返回</span> 数据记录</div>
        <p style="color:#666; font-size:14px;">点击行可查看详情。</p>
        <div id="record-list">
            </div>
        <button class="btn-danger btn-block" onclick="clearRecords()" style="margin-top:20px;">清空记录</button>
    </div>

    <div id="page-mod4" class="page">
        <div class="header"><span onclick="navTo('page-home')">← 返回</span> 农药单位换算助手</div>
        
        <div class="form-group">
            <label>输入值</label>
            <input type="number" id="m4-val">
        </div>
        
        <div class="form-group">
            <label>转换类型</label>
            <select id="m4-type">
                <option value="mu_to_m2">亩 → 平方米</option>
                <option value="m2_to_mu">平方米 → 亩</option>
                <option value="ha_to_mu">公顷 → 亩</option>
                <option value="ppm_to_perc">PPM → 百分比(%)</option>
            </select>
        </div>

        <button class="btn-primary btn-block" onclick="runTool()">转换</button>
        <div id="m4-result" class="result-box" style="display:none; text-align: center; font-size: 20px;"></div>
    </div>

    <script>
        // --- 核心导航逻辑 ---
        function enterApp() {
            document.getElementById('disclaimer').style.display = 'none';
            navTo('page-home');
            loadRecords();
        }

        function closeApp() {
            alert("请关闭浏览器窗口退出。");
        }

        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // --- 模块 1: 小区排列逻辑 ---
        function generatePlot(type) {
            const t = parseInt(document.getElementById('m1-treatments').value);
            const r = parseInt(document.getElementById('m1-reps').value);
            const output = document.getElementById('m1-output');
            
            if (!t || !r) { alert("请输入处理数和重复数"); return; }

            let html = `<h4>${type === 'RCBD' ? '随机区组' : type === 'RCBD_COL' ? '随机区组(错列)' : '完全随机'}示意图</h4><table>`;
            
            // 生成处理编号数组 [1, 2, ..., t]
            let treatments = Array.from({length: t}, (_, i) => i + 1);
            let grid = [];

            if (type === 'CRD') {
                // 完全随机：生成所有可能的小区 T*R 个
                let allPlots = [];
                for(let i=1; i<=t; i++) {
                    for(let j=1; j<=r; j++) {
                        allPlots.push(`${i}-${j}`); // 处理-重复
                    }
                }
                // 打乱
                allPlots.sort(() => Math.random() - 0.5);
                
                // 按行显示（这里假设还是按重复数的宽度来显示，方便查看，或者只是流式布局）
                // 为了表格美观，我们按照每行 r 个或者 t 个来排，这里按 r 个一行显示
                let cols = r; 
                let rows = t; 
                // CRD 不强制在同一行，这里只是为了视觉上的表格化
                let count = 0;
                for(let i=0; i<rows; i++) {
                    html += "<tr>";
                    for(let j=0; j<cols; j++) {
                        html += `<td>${allPlots[count] || ''}</td>`;
                        count++;
                    }
                    html += "</tr>";
                }

            } else {
                // 随机区组 (RCBD)
                // 每一行是一个重复 (Block)
                // 第一行是 Rep 1，包含处理 1~t
                
                for(let i=1; i<=r; i++) { // 遍历重复（行）
                    let rowTreatments = [...treatments];
                    
                    if (type === 'RCBD_COL' && grid.length > 0) {
                        // 尝试错列：尽量让当前列的处理不与上一行同一列的处理相同
                        // 这是一个简单的混洗尝试，不保证完美（完美错列是拉丁方逻辑，限制较多）
                        let attempts = 0;
                        let valid = false;
                        while(!valid && attempts < 100) {
                            rowTreatments.sort(() => Math.random() - 0.5);
                            valid = true;
                            // 检查每一列
                            for(let c=0; c<t; c++) {
                                let prevRow = grid[grid.length-1];
                                if(prevRow[c] === rowTreatments[c]) {
                                    valid = false;
                                    break;
                                }
                            }
                            attempts++;
                        }
                    } else {
                        // 普通随机
                        rowTreatments.sort(() => Math.random() - 0.5);
                    }
                    
                    grid.push(rowTreatments);

                    html += "<tr>";
                    // 第一列显示重复编号，后面显示处理
                    html += `<td style='background:#eee'><b>Rep ${i}</b></td>`;
                    rowTreatments.forEach(trt => {
                        html += `<td>${trt}-${i}</td>`; // 显示 处理-重复
                    });
                    html += "</tr>";
                }
            }

            html += "</table>";
            output.innerHTML = html;
        }

        // --- 模块 2: 计算用药量逻辑 ---
        
        // 密度计算
        function calcDensity() {
            const w = parseFloat(document.getElementById('m2-density-weight').value);
            if(!w) return;
            // 逻辑: 1ml 的重量是 w 克 -> 密度 = w g/ml
            const density = w; 
            document.getElementById('m2-density-result').innerText = `密度: ${density} g/ml`;
        }

        function toggleUnitType() {
            const type = document.getElementById('m2-unit-type').value;
            if (type === 'area') {
                document.getElementById('lbl-water').innerText = "用水量 (升/公顷)";
                document.getElementById('lbl-area').innerText = "小区面积 (m²)";
                document.getElementById('lbl-dosage').innerText = "亩用药量 (制剂/亩)";
                document.getElementById('m2-dosage').placeholder = "g或ml";
            } else {
                document.getElementById('lbl-water').innerText = "每株用水量 (升/株)"; // 逻辑调整：株模式下通常输入单株用水
                document.getElementById('lbl-area').innerText = "小区株数 (株)";
                document.getElementById('lbl-dosage').innerText = "稀释倍数";
                document.getElementById('m2-dosage').placeholder = "例如: 2000";
            }
        }

        let currentCalcData = null; // 用于保存

        function calcDosage() {
            const type = document.getElementById('m2-unit-type').value;
            const waterInput = parseFloat(document.getElementById('m2-water').value);
            const areaOrCount = parseFloat(document.getElementById('m2-area-size').value);
            const dosageOrDilution = parseFloat(document.getElementById('m2-dosage').value);
            const safety = parseFloat(document.getElementById('m2-safety').value) || 1.1;
            const reps = parseFloat(document.getElementById('m2-reps').value) || 1;

            if(!waterInput || !areaOrCount || !dosageOrDilution) {
                alert("请填写完整信息");
                return;
            }

            let resultHTML = "";
            let plotDrug = 0; // 每小区药量
            let plotWater = 0; // 每小区水量

            if (type === 'area') {
                // 面积模式 (m²)
                // 1. 每小区制剂用量 = (亩用药量 / 666.67) * 小区面积
                const muToM2 = 666.667;
                plotDrug = (dosageOrDilution / muToM2) * areaOrCount;
                
                // 2. 每小区用水量 (ml) = (公顷用水 L / 10000) * 小区面积 * 1000
                plotWater = (waterInput / 10000) * areaOrCount * 1000;

                resultHTML += `每小区理论用药: ${plotDrug.toFixed(3)} (g或ml)\n`;
                resultHTML += `每小区理论用水: ${plotWater.toFixed(1)} ml\n`;

            } else {
                // 株数模式
                // 1. 每小区用水量 (ml) = 单株用水(L) * 株数 * 1000
                plotWater = waterInput * areaOrCount * 1000;
                
                // 2. 每小区用药量 = 总水 / 稀释倍数
                plotDrug = plotWater / dosageOrDilution; // 此时单位是 g或ml

                resultHTML += `每小区理论用水: ${plotWater.toFixed(1)} ml\n`;
                resultHTML += `每小区理论用药: ${plotDrug.toFixed(3)} (g或ml)\n`;
            }

            // 计算处理总量（含安全系数和重复）
            const totalDrug = plotDrug * reps * safety;
            const totalWater = plotWater * reps * safety;

            resultHTML += `------------------\n`;
            resultHTML += `<b>最终处理称样量 (×${reps}重复, ×${safety}安全):</b>\n`;
            resultHTML += `<b style='color:red; font-size:1.2em'>药剂: ${totalDrug.toFixed(3)} (g或ml)</b>\n`;
            resultHTML += `兑水总量: ${totalWater.toFixed(1)} ml`;

            const resDiv = document.getElementById('m2-result');
            resDiv.innerHTML = resultHTML;
            resDiv.style.display = 'block';
            document.getElementById('btn-save-record').style.display = 'block';

            // 缓存数据用于保存
            currentCalcData = {
                desc: type === 'area' ? `${areaOrCount}m²小区` : `${areaOrCount}株小区`,
                result: `药:${totalDrug.toFixed(3)}, 水:${totalWater.toFixed(1)}`
            };
        }

        // --- 模块 3: 数据记录逻辑 ---
        function saveCurrentCalc() {
            if(!currentCalcData) return;
            const id = prompt("请输入编号或备注:", "Test-001");
            if(id) {
                const record = {
                    id: id,
                    time: new Date().toLocaleString(),
                    data: currentCalcData
                };
                
                let records = JSON.parse(localStorage.getItem('lims_records') || "[]");
                records.unshift(record);
                localStorage.setItem('lims_records', JSON.stringify(records));
                alert("保存成功");
                loadRecords(); // 刷新列表
            }
        }

        function loadRecords() {
            const list = document.getElementById('record-list');
            let records = JSON.parse(localStorage.getItem('lims_records') || "[]");
            
            if(records.length === 0) {
                list.innerHTML = "<div style='text-align:center;color:#999'>暂无记录</div>";
                return;
            }

            let html = "";
            records.forEach(r => {
                html += `
                <div class="data-item" onclick="alert('详情:\\n${r.data.desc}\\n${r.data.result}')">
                    <div style="font-weight:bold;">${r.id}</div>
                    <div style="font-size:14px; margin:5px 0;">${r.data.result}</div>
                    <small>${r.time}</small>
                </div>`;
            });
            list.innerHTML = html;
        }

        function clearRecords() {
            if(confirm("确定清空所有记录吗？")) {
                localStorage.removeItem('lims_records');
                loadRecords();
            }
        }

        // --- 模块 4: 辅助工具 ---
        function runTool() {
            const val = parseFloat(document.getElementById('m4-val').value);
            const type = document.getElementById('m4-type').value;
            const resBox = document.getElementById('m4-result');
            
            if(isNaN(val)) return;

            let res = 0;
            let unit = "";

            switch(type) {
                case 'mu_to_m2':
                    res = val * 666.667;
                    unit = "m²";
                    break;
                case 'm2_to_mu':
                    res = val / 666.667;
                    unit = "亩";
                    break;
                case 'ha_to_mu':
                    res = val * 15;
                    unit = "亩";
                    break;
                case 'ppm_to_perc':
                    res = val / 10000;
                    unit = "%";
                    break;
            }
            
            resBox.innerText = `${res.toFixed(4)} ${unit}`;
            resBox.style.display = 'block';
        }

    </script>
</body>
</html>

